<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei';
            background: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header .title {
            font-size: 20px;
            font-weight: bold;
        }
        .header .admin-info {
            font-size: 16px;
        }
        .header .logout {
            color: white;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 10px;
        }
        .container {
            width: 95%;
            max-width: 1400px;
            margin: 30px auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin: 2px;
        }
        .update-btn {
            background: #28a745;
            color: white;
        }
        .logistics-add-btn {
            background: #667eea;
            color: white;
        }
        .logistics-track-btn {
            background: #17a2b8;
            color: white;
        }
        .logistics-form {
            margin-top: 10px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            display: none;
            background: #f9f9f9;
        }
        .logistics-form .form-row {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logistics-form label {
            width: 80px;
            font-weight: bold;
        }
        .logistics-form select, .logistics-form input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            flex: 1;
            max-width: 200px;
        }
        .logistics-info {
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #f0f8ff;
        }
        .progress-text {
            color: #dc3545;
            font-weight: bold;
        }
        .courier-info {
            color: #667eea;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="title">文创产品定制平台 - 管理员后台</div>
    <div class="admin-info">
        当前管理员: <span id="adminName"></span>
        <span class="logout" onclick="logout()">退出登录</span>
    </div>
</div>
<div class="container">
    <div class="panel-title">订单管理</div>
    <table>
        <thead>
        <tr>
            <th width="8%">订单ID</th>
            <th width="12%">产品类型</th>
            <th width="15%">尺寸</th>
            <th width="15%">材质</th>
            <th width="12%">联系方式</th>
            <th width="10%">当前状态</th>
            <th width="12%">修改状态</th>
            <th width="16%">操作</th>
        </tr>
        </thead>
        <tbody id="orderTable"></tbody>
    </table>
</div>

<script>
    // 验证管理员登录
    const admin = JSON.parse(localStorage.getItem("admin"));
    if (!admin) window.location.href = "admin-login.html";
    document.getElementById("adminName").textContent = admin.username;

    // 快递公司列表
    const logisticsCompanies = [
        "顺丰速运", "中通快递", "圆通快递", "韵达快递",
        "申通快递", "天天快递", "EMS", "京东物流"
    ];

    // 加载订单列表
    async function loadOrders() {
        const res = await fetch("/api/order/all");
        const data = await res.json();
        const table = document.getElementById("orderTable");
        table.innerHTML = "";

        if (data.code === 200 && data.data.length > 0) {
            data.data.forEach(order => {
                const row = document.createElement("tr");
                row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.productType}</td>
                        <td>${order.size}</td>
                        <td>${order.material}</td>
                        <td>${order.contact}</td>
                        <td>${order.status}</td>
                        <td>
                            <select class="status-select" data-id="${order.id}" onchange="statusChange(${order.id}, this)">
                                <option value="待审核" ${order.status === "待审核" ? "selected" : ""}>待审核</option>
                                <option value="待生产" ${order.status === "待生产" ? "selected" : ""}>待生产</option>
                                <option value="已发货" ${order.status === "已发货" ? "selected" : ""}>已发货</option>
                                <option value="已完成" ${order.status === "已完成" ? "selected" : ""}>已完成</option>
                            </select>
                        </td>
                        <td>
                            <button class="btn update-btn" onclick="updateStatus(${order.id})">更新状态</button>
                            <button class="btn logistics-add-btn" onclick="showLogisticsForm(${order.id})">物流填写</button>
                            <button class="btn logistics-track-btn" onclick="trackLogistics(${order.id})">物流追踪</button>
                            <!-- 物流表单 -->
                            <div class="logistics-form" id="logisticsForm${order.id}">
                                <div class="form-row">
                                    <label>快递公司：</label>
                                    <select class="logistics-company" data-id="${order.id}">
                                        ${logisticsCompanies.map(company => `<option value="${company}">${company}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-row">
                                    <label>快递单号：</label>
                                    <input type="text" class="tracking-no" data-id="${order.id}" placeholder="请输入快递单号">
                                </div>
                                <div class="form-row">
                                    <label>快递员姓名：</label>
                                    <input type="text" class="courier-name" data-id="${order.id}" placeholder="请输入快递员姓名">
                                </div>
                                <div class="form-row">
                                    <label>快递员电话：</label>
                                    <input type="text" class="courier-phone" data-id="${order.id}" placeholder="请输入快递员电话">
                                </div>
                                <div class="form-row">
                                    <button class="btn update-btn" onclick="saveLogistics(${order.id})">保存物流信息</button>
                                </div>
                            </div>
                            <!-- 物流信息展示 -->
                            <div class="logistics-info" id="logisticsInfo${order.id}" style="display: none;">
                                <div>物流公司：<span class="company-text"></span></div>
                                <div>快递单号：<span class="tracking-text"></span></div>
                                <div>物流进度：<span class="progress-text"></span></div>
                                <div class="courier-info">
                                    快递员：<span class="courier-name-text"></span> | 电话：<span class="courier-phone-text"></span>
                                </div>
                            </div>
                        </td>
                    `;
                table.appendChild(row);

                // 如果订单状态已是已发货，加载最新物流信息
                if (order.status === "已发货") {
                    loadLogisticsInfo(order.id);
                }
            });
        } else {
            table.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">暂无订单数据</td></tr>';
        }
    }

    // 状态变更监听（改为已发货时自动弹出物流表单）
    function statusChange(orderId, selectElement) {
        const status = selectElement.value;
        if (status === "已发货") {
            showLogisticsForm(orderId);
            alert("订单状态已改为已发货，请填写物流信息！");
        }
    }

    // 更新订单状态
    async function updateStatus(id) {
        const status = document.querySelector(`.status-select[data-id="${id}"]`).value;
        await fetch("/api/order/updateStatus", {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            body: `id=${id}&status=${status}`
        });
        // 刷新订单列表，确保状态同步
        loadOrders();
    }

    // 显示物流表单
    function showLogisticsForm(id) {
        // 隐藏所有其他物流表单
        document.querySelectorAll('.logistics-form').forEach(form => {
            form.style.display = 'none';
        });
        // 显示当前订单的物流表单
        const form = document.getElementById(`logisticsForm${id}`);
        form.style.display = 'block';
        // 滚动到表单位置
        form.scrollIntoView({behavior: 'smooth'});
    }

    // 保存物流信息（含快递员）- 优化：保存后强制刷新
    async function saveLogistics(id) {
        const company = document.querySelector(`.logistics-company[data-id="${id}"]`).value;
        const trackingNo = document.querySelector(`.tracking-no[data-id="${id}"]`).value;
        const courierName = document.querySelector(`.courier-name[data-id="${id}"]`).value;
        const courierPhone = document.querySelector(`.courier-phone[data-id="${id}"]`).value;

        if (!trackingNo || !courierName || !courierPhone) {
            alert("请填写完整的物流信息（快递单号、快递员姓名、电话不能为空）！");
            return;
        }

        await fetch("/api/logistics/save", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                orderId: id,
                company: company,
                trackingNo: trackingNo,
                courierName: courierName,
                courierPhone: courierPhone
            })
        });

        alert("物流信息已保存！");
        // 隐藏表单
        document.getElementById(`logisticsForm${id}`).style.display = 'none';
        // 强制刷新订单列表和物流信息，确保同步
        loadOrders();
    }

    // 加载物流信息 - 优化：每次都请求最新数据
    async function loadLogisticsInfo(id) {
        const res = await fetch(`/api/logistics/${id}`);
        const data = await res.json();
        if (data.data) {
            const logisticsInfo = document.getElementById(`logisticsInfo${id}`);
            logisticsInfo.style.display = 'block';
            logisticsInfo.querySelector('.company-text').textContent = data.data.company;
            logisticsInfo.querySelector('.tracking-text').textContent = data.data.trackingNo;
            logisticsInfo.querySelector('.progress-text').textContent = data.data.progress;
            logisticsInfo.querySelector('.courier-name-text').textContent = data.data.courierName;
            logisticsInfo.querySelector('.courier-phone-text').textContent = data.data.courierPhone;
        }
    }

    // 追踪物流轨迹 - 优化：追踪后刷新物流信息
    async function trackLogistics(id) {
        const res = await fetch(`/api/logistics/track/${id}`);
        const data = await res.json();
        if (data.data) {
            const logisticsInfo = document.getElementById(`logisticsInfo${id}`);
            if (logisticsInfo.style.display === 'none') {
                logisticsInfo.style.display = 'block';
            }
            // 更新物流进度
            logisticsInfo.querySelector('.progress-text').textContent = data.data.progress;
            alert("物流轨迹已更新！");
            // 可选：刷新整个订单列表，确保数据完全同步
            loadOrders();
        } else {
            alert("该订单暂无物流信息，请先填写！");
            showLogisticsForm(id);
        }
    }

    // 退出登录
    function logout() {
        localStorage.removeItem("admin");
        window.location.href = "admin-login.html";
    }

    // 页面加载时加载订单
    loadOrders();
</script>
</body>
</html>